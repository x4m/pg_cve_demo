FROM ubuntu:jammy as pg14

RUN apt-get update && apt-get install -y --no-install-recommends \
    sudo \
    build-essential \
    cmake \
    clang \
    bison flex git \
    curl \
    lsb-release \
    ca-certificates \
    libssl-dev \
    libreadline-dev \
    cron

WORKDIR /pg14

RUN git clone --single-branch --branch REL_14_2 --depth 1 https://github.com/postgres/postgres

ENV CC=clang

RUN cd postgres && \
    ./configure --prefix=$PWD --enable-depend --build=aarch64-unknown-linux-gnu \
                --without-zlib > /dev/null && \
    make -j12 > /dev/null && \
    make -j12 install > /dev/null

RUN cd postgres/contrib/amcheck && make -j12 install

RUN useradd -ms /bin/bash postgres

RUN touch /var/log/amcheck.log
RUN chmod 0666 /var/log/amcheck.log

COPY <<EOF entrypoint.sh
#!/bin/bash
(while :; do sleep 1; echo "amcheck run"; postgres/bin/pg_amcheck --heapallindexed db1 >> /var/log/amcheck.log; done)&
postgres/bin/postgres -D /home/postgres/test_db
EOF
RUN chmod +x entrypoint.sh

USER postgres

RUN postgres/bin/initdb /home/postgres/test_db

RUN echo "host    all             all             0.0.0.0/0            md5">>/home/postgres/test_db/pg_hba.conf
RUN echo "listen_addresses = '*'" >> /home/postgres/test_db/postgresql.conf

FROM pg14 as target
RUN postgres/bin/pg_ctl -D /home/postgres/test_db  -w start && \
    postgres/bin/psql -c "create user user1 password 'password'"  && \
    postgres/bin/psql -c "create database db1" && \
    postgres/bin/psql -c "grant all on database db1 to user1"  && \
    postgres/bin/psql -c "create database secret_db"  && \
    postgres/bin/psql -c "create table secret_table as select 'flag' as c" secret_db  && \
    postgres/bin/psql -c "create extension amcheck" db1 && \
    postgres/bin/pg_ctl -D /home/postgres/test_db -w stop


EXPOSE 5432/tcp

CMD ["/pg14/entrypoint.sh"]
