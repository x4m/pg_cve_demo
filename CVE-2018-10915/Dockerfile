FROM ubuntu:jammy as pg10

RUN apt-get update && apt-get install -y --no-install-recommends \
    sudo \
    build-essential \
    cmake \
    clang \
    bison flex git \
    curl \
    lsb-release \
    ca-certificates \
    libssl-dev \
    libreadline-dev

WORKDIR /pg10

RUN git clone --single-branch --branch REL_10_4 --depth 1 https://github.com/postgres/postgres

ENV CC=clang

RUN cd postgres && \
    ./configure --prefix=$PWD --enable-depend --build=aarch64-unknown-linux-gnu \
                --without-zlib > /dev/null && \
    make -j12 > /dev/null && \
    make -j12 install > /dev/null

RUN cd postgres/contrib/dblink && make -j12 install

RUN useradd -ms /bin/bash postgres

USER postgres

RUN postgres/bin/initdb /home/postgres/test_db

RUN echo "host    all             all             0.0.0.0/0            md5">>/home/postgres/test_db/pg_hba.conf
RUN echo "listen_addresses = '*'" >> /home/postgres/test_db/postgresql.conf

FROM pg10 as target
RUN postgres/bin/pg_ctl -D /home/postgres/test_db  -w start && \
    postgres/bin/psql -c "create user user1 password 'password'"  && \
    postgres/bin/psql -c "create database db1" && \
    postgres/bin/psql -c "grant all on database db1 to user1"  && \
    postgres/bin/psql -c "create database secret_db"  && \
    postgres/bin/psql -c "create table secret_table as select 'flag' as c" secret_db  && \
    postgres/bin/psql -c "create extension dblink" db1 && \
    postgres/bin/pg_ctl -D /home/postgres/test_db -w stop

EXPOSE 5432/tcp
CMD ["postgres/bin/postgres", "-D", "/home/postgres/test_db"]

FROM pg10 as pg10-controlled
RUN postgres/bin/pg_ctl -D /home/postgres/test_db  -w start && \
    postgres/bin/psql -c "alter user postgres password 'password'"  && \
    postgres/bin/psql -c "create extension dblink" && \
    postgres/bin/pg_ctl -D /home/postgres/test_db -w stop

RUN echo "port = 5433" >> /home/postgres/test_db/postgresql.conf

EXPOSE 5433/tcp
CMD ["postgres/bin/postgres", "-D", "/home/postgres/test_db"]