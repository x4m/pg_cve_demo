FROM ubuntu:jammy as pg8

WORKDIR /pg8

RUN apt-get update && apt-get install -y --no-install-recommends \
    sudo \
    build-essential \
    cmake \
    clang \
    bison flex git \
    curl \
    lsb-release \
    ca-certificates \
    libssl-dev \
    libreadline-dev

RUN git clone --single-branch --branch REL8_2_5 --depth 1 https://github.com/postgres/postgres

ENV CC=clang

RUN cd postgres && ./configure --prefix=$PWD --enable-depend --build=aarch64-unknown-linux-gnu --without-zlib --disable-spinlocks && make -j12 > /dev/null && make -j12 install > /dev/null

RUN cd postgres/contrib/dblink && make -j12 install

RUN useradd -ms /bin/bash postgres

USER postgres

RUN postgres/bin/initdb /home/postgres/test_db


RUN echo "host    all             all             0.0.0.0/0            md5">>/home/postgres/test_db/pg_hba.conf
RUN cat /home/postgres/test_db/pg_hba.conf

#RUN echo "listen_addresses = '127.0.0.1'">>/home/postgres/test_db/postgresql.conf

RUN postgres/bin/pg_ctl -D /home/postgres/test_db  -w start && \
    postgres/bin/psql -c "create user user1 password 'password'"  && \
    postgres/bin/psql -c "create database db1" && \
    postgres/bin/psql -c "grant all on database db1 to user1"  && \
    postgres/bin/psql -c "create database secret_db"  && \
    postgres/bin/psql -c "create table secret_table as select 'flag' as c" secret_db  && \
    postgres/bin/psql <postgres/contrib/dblink/dblink.sql && \
    postgres/bin/pg_ctl -D /home/postgres/test_db -w stop

RUN echo "listen_addresses = '*'">>/home/postgres/test_db/postgresql.conf

EXPOSE 5432/tcp
CMD ["postgres/bin/postgres", "-D", "/home/postgres/test_db"]