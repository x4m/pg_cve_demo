FROM ubuntu:jammy as pg8

WORKDIR /pg8

RUN apt-get update && apt-get install -y --no-install-recommends \
    sudo \
    build-essential \
    cmake \
    clang \
    bison flex git \
    curl \
    lsb-release \
    ca-certificates \
    libssl-dev \
    libreadline-dev

RUN git clone --single-branch --branch REL8_2_5 --depth 1 https://github.com/postgres/postgres

#ENTRYPOINT ["/bin/bash"]

ENV CC=clang

RUN cd postgres && ./configure --prefix=$PWD --enable-depend --build=aarch64-unknown-linux-gnu --without-zlib --disable-spinlocks && make -j12 > /dev/null && make -j12 install > /dev/null

RUN cd contrib && make -j12 install

RUN useradd -ms /bin/bash postgres

USER postgres

RUN postgres/bin/initdb /home/postgres/test_db
#RUN postgres/bin/pg_ctl -D $HOME/test_db start

FROM pg8

ENTRYPOINT ["postgres/bin/postgres", "-D", "/home/postgres/test_db"]